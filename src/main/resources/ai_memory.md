# ai_memory.md

## 2025-06-28
### 本次目标
- 实现树节点右键菜单，支持：
  - 复制字段路径
  - 复制节点值
  - 折叠/展开子树
  - 菜单可在节点整行任意位置弹出
- 在每个有子节点的树节点右侧显示"+"或"−"按钮，点击时递归展开/折叠该节点及其所有子节点，提升交互体验。
- 搜索框有内容时显示"清空"按钮，点击可一键清除（参考 IDEA search 框样式）。
- 在导航树面板增加"定位"按钮，点击时将编辑区光标所在 JSON 节点在树中高亮/滚动到可见（手动触发，不做实时同步）。

### 详细思路与决策
- 新建 TreeContextMenuUtils.kt 工具类，封装右键菜单逻辑。
- 在 JsonTreePanel 中为树节点添加右键菜单监听。
- 菜单项包括：复制字段路径、复制节点值、折叠/展开子树。
- 每项功能实现后及时测试，确保交互流畅。
- "编辑区光标同步高亮树节点"需求调整为：增加"定位"按钮，点击时才进行同步高亮，避免频繁自动同步。
- 右键菜单弹出逻辑增强：优先在点击行弹出菜单，若未点到行但有选中节点也弹菜单，极大提升易用性。
- 自定义树渲染器（TreeCellRenderer），在有子节点的节点右侧绘制按钮。
- 按钮点击时递归展开/折叠该节点及所有子节点。
- 保持UI美观、交互流畅。
- 实现后及时测试，确保与现有右键菜单等功能兼容。
- 搜索框右侧增加"×"清空按钮，只有在有内容时才显示，点击即可一键清除内容并刷新树，UI风格贴近 IDEA。
- 在按钮栏增加"定位"按钮。
- 点击时，获取当前编辑区光标 offset。
- 遍历树结构，查找 PSI 元素 textRange 包含 offset 的节点。
- 在树中高亮/滚动到该节点。
- 只在用户主动点击时同步，不做实时自动同步。
- UI风格与现有按钮保持一致。

### 本次遗留问题与下次待办
- [ ] 代码结构和UI小优化
- [ ] 其他体验细节完善

### 阶段收尾总结
- 经过多轮开发与优化，Json Navigator 插件已实现核心功能、主要交互和体验细节，结构清晰，文档完善。
- 当前版本已达到可发布状态，后续可根据用户反馈持续优化。
- 编码工作阶段性告一段落，后续如有新需求可随时迭代。

---

## 2024-06-09
### 本次目标
- 完成基础架构设计，实现ToolWindow、树形结构导航、节点跳转、Markdown导出、UI优化等核心功能。

### 详细思路与决策
- 详见原始记录（保留全部历史内容，便于追溯）。

### 关键代码/设计片段
- 详见原始记录。

### 本次遗留问题与下次待办
- [ ] 右键菜单与更多操作
- [ ] 懒加载与性能优化（已归入后续待定需求）
- [ ] 国际化与设置面板
- [ ] 更多导出格式

---

## 后续待定需求

### 懒加载与性能优化
- 懒加载：只在节点展开时解析和加载子节点，未展开的深层节点不占用内存。
- 性能优化：避免一次性解析大文件，提升大文件下的响应速度和流畅度。
- 搜索局限：懒加载下，搜索仅能检索已加载（已展开）的节点，未加载的深层节点无法被搜索到。
- 全量搜索方案：如需全量搜索，可提供"深度搜索"按钮，用户主动触发时再全量解析（需进度提示，性能需评估）。
- 相关UI提示：如仅支持局部搜索，需在界面上明确提示用户。
- 该需求实现复杂，易出bug，且对大文件性能影响大，暂缓开发，后续如有需要可随时启动。

---

# 历史内容归档（保留全部原有内容，便于追溯）

## 项目初始设计思路

### 背景
面对大内容 JSON 文件时，编辑和阅读非常困难。需要一个结构化的导航视图，提升开发和阅读效率。

### 目标功能
- 树形结构的导航视图，展示 JSON 文件总览、数组元素个数、各节点字段。
- 支持刷新、折叠/展开等基本操作。
- 支持点击树节点时，主编辑区自动跳转到对应 JSON 位置。
- 支持将导航视图导出为类似接口文档字段结构的 markdown 文件。
- 支持类似 mongodb 的检索条件。

### 技术选型
- 主要开发语言：Kotlin
- 平台：IntelliJ Platform Plugin
- UI：ToolWindow + TreeView
- 解析：PSI 解析 JSON 结构

### 实现计划
1. 注册 ToolWindow，显示基础 UI。
2. 监听 JSON 文件，解析结构并展示树形视图。
3. 支持节点跳转、刷新、折叠/展开。
4. 导出 markdown，支持检索。

---

# 以下为2024-06-09及之前的详细开发记录（原始内容保留）

（原有内容已分块整理，便于后续查阅）

## 2024-06-09
- 完成基础架构设计，准备实现 ToolWindow。

## 2024-06-09 基础架构实现
- 在 plugin.xml 的 <extensions> 节点下注册 ToolWindow，id 为 JsonNavigator，工厂类为 chi.quran0.jsonnavigator.JsonNavigatorToolWindowFactory。
- 创建 JsonNavigatorToolWindowFactory.kt，使用 Kotlin 实现 ToolWindow 工厂，初步 UI 显示 'Hello JSON Navigator'。
- 下一步将实现 JSON 文件监听与树形结构展示。

## 2024-06-09 树形结构导航视图设计
- 目标：在 ToolWindow 中显示当前 JSON 文件的结构树，支持字段名、数组元素个数等信息。
- 步骤：
  1. 监听当前编辑器文件，仅在 JSON 文件时激活导航视图。
  2. 用 PSI 解析 JSON 文件，生成树形数据结构。
  3. 用 JTree（或 IntelliJ Tree API）在 ToolWindow 展示结构，支持折叠/展开。
  4. 支持刷新功能，文件内容变化时自动/手动刷新树结构。
- 计划：
  - 先实现静态 JSON 的树形展示，后续再做动态监听和刷新。

## 2024-06-09 动态解析 JSON 文件并展示树结构
- 目标：监听当前编辑器文件，若为 JSON 文件则用 PSI 解析其结构并用树形组件展示。
- 步骤：
  1. 监听编辑器切换事件，获取当前激活文件。
  2. 判断文件类型是否为 JSON。
  3. 用 PSI 解析 JSON 文件，生成适合 JTree 展示的树形结构（字段名、数组元素个数等）。
  4. 切换到 JSON 文件时自动刷新树形结构，非 JSON 文件时显示提示或空视图。
- 计划：
  - 先实现文件切换监听和 JSON 识别，后续再完善 PSI 解析和树结构生成。

## 2024-06-09 用 PSI 解析 JSON 并生成树结构
- 目标：用 PSI 解析当前 JSON 文件，递归生成 JTree 需要的树形结构，动态展示真实 JSON 结构。
- 步骤：
  1. 通过 PsiManager 获取当前 VirtualFile 的 PsiFile，并判断是否为 JSON 文件（JsonFile 类型）。
  2. 递归遍历 PSI 树，处理 JsonObject、JsonArray、JsonProperty 等元素，构建 DefaultMutableTreeNode 树形结构。
  3. 用 JTree 展示解析结果，替换原有静态/提示内容。
- 计划：
  - 先实现基础 PSI 解析和树结构生成，后续再优化节点信息展示和交互。

## 2024-06-09 国际化决策
- 插件窗口的所有操作、提示语、按钮等用户可见信息统一采用英文，便于后续国际化和更广泛用户使用。

## 2024-06-09 树形结构与UI优化
- 目标：
  1. 支持 root 为 JSON 数组时显示数组大小。
  2. ToolWindow 顶部增加"Expand All""Collapse All"按钮，递归展开/折叠所有节点。
  3. 优化 JTree 和整体面板样式（字体、行高、边框、按钮风格等）。
- 步骤：
  - 检查 root 类型，若为 JsonArray，根节点显示数组信息并递归展示内容。
  - 添加按钮并实现递归展开/折叠。
  - 设置 JTree 行高、字体、去除丑陋边框，按钮样式统一。

## 2024-06-09 代码结构优化与分包
- 目标：入口类精简，按功能分包，提升可维护性和扩展性。
- 推荐结构：
```
  chi.quran0.jsonnavigator/
    ├── ui/
    │     ├── JsonNavigatorToolWindowFactory.kt   // 入口，精简，仅负责UI初始化
    │     └── JsonTreePanel.kt                    // 负责树形结构UI、按钮、样式
    ├── tree/
    │     └── JsonTreeBuilder.kt                  // 负责 PSI 解析和树结构生成
    └── util/
          └── TreeUtils.kt                        // 递归展开/折叠等工具方法
```
- 步骤：
  1. 入口类只负责 ToolWindow 注册和 UI 初始化，其他逻辑全部委托。
  2. UI、树结构、工具方法分别独立分包，便于后续维护和扩展。

## 2024-06-09 树节点点击跳转定位
- 目标：点击树节点时，主编辑区自动跳转到对应 JSON 位置。
- 步骤：
  1. 树节点数据结构扩展，保存 PSI 元素或 offset。
  2. 监听 JTree 节点点击事件，获取被选中节点的 PSI 元素。
  3. 用 FileEditorManager/Editor 定位并高亮 PSI 元素或 offset。
- 计划：
  - 优先实现 PSI 元素跳转，后续可支持高亮和多选。

## 2024-06-09 导出 Markdown 功能
- 目标：一键导出当前 JSON 结构树为接口文档风格的 Markdown 文件。
- 步骤：
  1. ToolWindow 顶部按钮栏新增"Export Markdown"按钮。
  2. 遍历树结构，递归生成 Markdown 列表（缩进），包含字段名、类型、示例值（如可获取）。
  3. 弹出保存对话框，用户选择保存路径，将 Markdown 写入文件。
  4. 可选：支持直接复制到剪贴板。
- 计划：
  - 先实现基础导出，后续可扩展表格、类型推断、示例值等。

## 2024-06-09 Markdown导出表格样式
- 目标：导出为表格样式，表头为：字段名 | 类型 | 描述 | 实例数据。
- 规则：
  - 描述列为空。
  - 数组类型为 xxx[]，字段名加 []。
  - 层级结构用 - 表示（如 -user、--name、--tags[]）。
- 步骤：
  1. 递归遍历树结构，生成扁平表格行，前缀用 - 表示层级。
  2. 类型根据 PSI 判断（object、string、number、xxx[]等）。
  3. 实例数据取 PSI 的 text 或子节点示例。

## 2024-06-09 编辑区光标同步高亮导航树节点
- 目标：编辑区光标移动时，导航树自动高亮对应节点，实现双向同步。
- 步骤：
  1. 监听当前 JSON 文件的编辑器 caret/cursor 变化事件。
  2. 获取当前 caret offset。
  3. 遍历树结构，查找 PSI 元素 textRange 包含 offset 的节点。
  4. 用 tree.setSelectionPath() 选中并滚动到该节点。
- 计划：
  - 优先支持单光标同步，后续可扩展多选/高亮。

## 2024-06-09 树节点检索/过滤功能优化
- 目标：
  1. 搜索框独占一行，提升美观和可用性。
  2. 支持复杂表达式过滤，如 {"odds_change.odds.market.id":115}，可按路径和值精确匹配。
  3. 搜索结果中，命中节点的所有子节点都应显示（命中即展开），而不是只显示命中节点和父节点。
- 步骤：
  - UI：将搜索框和按钮栏分为两行。
  - 表达式解析：支持 JSON 路径和值的表达式，解析后递归匹配树节点。
  - 过滤逻辑：命中节点及其所有子节点都显示，父节点用于追溯路径。

## 2024-06-09 新一轮需求与优化方向
### 当前优先
1. 树节点检索/过滤（MongoDB风格）
    - 支持在导航树中输入检索条件，快速定位字段或结构（如支持 key、类型、路径等过滤）。
    - 实现搜索框，支持简单表达式或关键字过滤。
2. 节点右键菜单/更多操作
    - 在导航栏的节点最右边添加展开/合并按钮，点击可展开/合并该节点及所有子节点。
    - 支持右键复制字段路径、复制节点值（为对象时复制其整个结构）、折叠/展开子树等。
3. 性能与体验优化
    - 大文件下的懒加载、异步解析、UI 响应优化。

### 后续考虑
4. 国际化与设置面板
    - 支持多语言、主题适配、用户自定义导出模板等。
5. 更多导出格式
    - 支持导出为 JSON Schema、YAML、Excel 等。

## 后续需求
- 编辑区光标移动时，导航树同步高亮对应节点（双向同步）。
  - 监听编辑器光标变化，查找 PSI 元素并在树中选中对应节点。
  - 优先级：当前导出 Markdown 功能完成后实现。

## 2024-06-09 搜索/过滤逻辑结构优化
- 目标：将树节点的搜索/过滤逻辑单独抽离为 tree/JsonTreeFilter.kt，UI 只负责交互，逻辑更清晰、易扩展。
- 步骤：
  1. 创建 JsonTreeFilter，负责所有过滤、表达式解析、路径匹配等。
  2. JsonTreePanel 只负责 UI，调用 JsonTreeFilter 完成过滤。

## 2024-06-09 UI布局与搜索帮助优化
- 目标：
  1. 搜索框独占一行，右侧加"?"帮助图标，按钮栏单独一行，整体更美观。
  2. 点击"?"图标弹出对话框，展示搜索格式示例，便于用户理解用法。
- 搜索示例：
  - 关键字搜索: name
  - 路径搜索: odds_change.odds.market.id
  - 路径+值: {"odds_change.odds.market.id":115}
  - 类型搜索: type:array 

## 2024-06-09 阶段性进度总结
1. UI与交互优化
   - 搜索框独占一行，右侧增加"?"帮助按钮，点击可查看搜索格式示例。
   - 按钮栏单独一行，FlowLayout，按钮高度自适应，整体布局美观紧凑。
   - 树形结构区域最大化利用空间，三者分明。
2. 搜索与过滤功能
   - 支持关键字、路径、路径+值、类型等多种搜索方式。
   - 支持 MongoDB 风格表达式（如{"odds_change.odds.market.id":115}）。
   - 命中节点的所有子节点都显示，父节点用于追溯路径。
   - 搜索/过滤逻辑已独立为 JsonTreeFilter，UI 代码更简洁。
3. 核心功能完善
   - 树节点点击跳转编辑区、编辑区光标同步高亮树节点。
   - Markdown 导出支持表格样式，数组节点只导出第一个元素结构。
   - 代码结构分包，易于维护和扩展。
4. 文档与总结
   - ai_memory.md、ai_summary.md 均已同步记录最新设计、实现和阶段性成果。

## 后续待定需求

### 懒加载与性能优化
- 懒加载：只在节点展开时解析和加载子节点，未展开的深层节点不占用内存。
- 性能优化：避免一次性解析大文件，提升大文件下的响应速度和流畅度。
- 搜索局限：懒加载下，搜索仅能检索已加载（已展开）的节点，未加载的深层节点无法被搜索到。
- 全量搜索方案：如需全量搜索，可提供"深度搜索"按钮，用户主动触发时再全量解析（需进度提示，性能需评估）。
- 相关UI提示：如仅支持局部搜索，需在界面上明确提示用户。
- 该需求实现复杂，易出bug，且对大文件性能影响大，暂缓开发，后续如有需要可随时启动。

## 代码结构优化与扩展建议（长期参考）

1. util 包可根据工具类数量进一步细分为 export/、menu/ 等子包（如有需要）。
2. tree 包可增加接口/抽象类，为后续支持多种数据结构（如 XML、YAML）做准备。
3. UI 组件可进一步解耦，将搜索区、按钮区、树区分别拆分为小组件类，便于维护和测试。
4. 如交互复杂，可引入事件总线或状态管理类，避免 UI 组件间直接耦合。
5. UI 文本、提示语、按钮名等建议统一提取到常量或资源文件，便于国际化和维护。
6. 关键类、方法建议补充 KDoc 注释，提升团队协作和可维护性。

当前结构已非常清晰合理，未来如功能扩展可按上述建议逐步优化，无需一次性大重构。

--- 